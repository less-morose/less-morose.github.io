---
title: SOAR/SIEM Automation Project
date: 2025-08-14 00:00:00 +/-0500
categories: [PersonalProject]
tags: [idkwhattoputhere]     # TAG names should always be lowercase
---
## Infrastructure
![Desktop View](/assets/posts/SOARSIEM/preresponseNetworkDiagram.png)
<!-- ![Desktop View](/assets/posts/SOARSIEM/preresponseNetworkDiagram.png){: w="716" h="714" }  -->
- Both the Wazuh and TheHive Managers are hosted in separate Digital Ocean Ubuntu Droplets (VMs).  
- The Wazuh Agent is used to aggregate logs collected with Sysmon to the Wazuh Manager. It's hosted on my main machine where I also access the cloud consoles from.  
- Wazuh is then configured to connect to the SOAR software, Shuffle, to automatically calculate the SHA256 hash from the mimikatz.exe alert to send to VirusTotal, generating an alert for TheHive, and sending a separate email for (theoretical) SOC Analysts  

## Installation/Configuration

### Firewall
![Desktop View](/assets/posts/SOARSIEM/digitaloceanFirewall.png){: w="200" .right }
Before initializing both the Wazuh and TheHive managers, by default port 22 (SSH) is open by default to allow remote connections by anyone. Obviously, for security reasons I need to restrict access to SSH or simply just close off the port to avoid scanners probing the droplets. I opted to just remove the option to connect via SSH and instead use the console provided by DigitalOcean. I also enabled all TCP/UDP connections from my public IP address for the Wazuh Agent to be able to communicate to/from the Wazuh Manager.

<!-- -->  
### Wazuh Agent

The Wazuh Manager has a very convenient way to setup the curl command to setup the Wazuh Agent. By selecting the OS version, and the IP address of the manager, it automatically creates a curl command and provides additional commands to start the service on the agent.  
```bash
curl -o wazuh-agent-4.7.5-1.x86_64.rpm https://packages.wazuh.com/4.x/yum/wazuh-agent-4.7.5-1.x86_64.rpm && sudo WAZUH_MANAGER='<public IP of Wazuh Manager>' WAZUH_AGENT_NAME='<Agent Name>' rpm -ihv wazuh-agent-4.7.5-1.x86_64.rpm
```
Below is the configured Windows 10 Wazuh Agent.  
![Desktop View](/assets/posts/SOARSIEM/wazuh-manager-agents.png)
_I named the agent, 'socforensicsincidentresponse' to remember the 'FIR' in 'DFIR' :)_  

Installing sysmon is even easier. By installing the the Sysmon service through the Microsoft Documentation, and a systemconfig.xml file offered through the GitHub linked in that documentation page.
```bash
.\Sysmon.exe -i sysmonconfig.xml
```
Under the 'ossec.conf' file under C:\Program Files (x86)\ossec-agent, I edited the already existing localfile header to the Sysmon file path (Microsoft-Windows-Sysmon/Operational) so that the Wazuh agent gets logs generated by Sysmon under the Log Analysis Section  
![Desktop View](/assets/posts/SOARSIEM/wazuh-agent-sysmon.png)
### TheHive Manager

Following TheHive's installation/configuration steps through their [documentation](https://docs.strangebee.com/thehive/installation/step-by-step-installation-guide/), essentially it configures the Cassandra and ElasticSearch services to be able to communicate with TheHive Manager.

### Wazuh Manager

For testing purposes, all logs will be pushed to the Wazuh Manager whether it triggers an alert/rule or not. To do this, I must change certain settings within the ossec.conf file and the Filebeats service configuration file on the _Wazuh Manager_ to reflect this.
![Desktop View](/assets/posts/SOARSIEM/wazuh-manager-ossec.png)
_Underlined terms were originally 'no'_  
Logs are saved under /var/ossec/logs/archives . Because I am ingesting ALL logs rather than just alerts, I need to configure the Filebeat service to reflect that. Under /etc/filebeat/filebeat.yml there is an area to enable archives.
![Desktop View](/assets/posts/SOARSIEM/wazuh-manager-filebeats.png)
_Like before, underlined term was originally 'false'_  
On the Wazuh Manager GUI itself, I still need to define another index pattern that reflects the archives themselves.
![Desktop View](/assets/posts/SOARSIEM/wazuh-manager-index.png)
The index goes through Wazuh's files, within its archives, and the '**' at the end defines everything within said archives.  

## Detecting Mimikatz 
Now that the log ingestion is configured and ready to go, it is time to create a custom rule that detects specifically Mimikatz. Because all archies are ingested, I can select some random log to look at the attributes that Sysmon offers.
![Desktop View](/assets/posts/SOARSIEM/mimikatz-initial-log.png)
The attributes in particular that I focused on are
- data.win.eventdata.image
	- The rule that will be created proves that this can be _very_ easily spoofed
- data.win.system.eventID
	- an eventID of 1 represents Process Creation. In properly made rules, this attributed used in tandem with other events contribute to process lineage to give insights on how the potential malware works or vulnerabilities within the environment.
- data.win.eventdata.originalFileName 
	- This will be used to circumvent spoofing the data.win.eventdata.image name.
![Desktop View](/assets/posts/SOARSIEM/mimikatz-attributes.png)

### Rule Creation

After scouring the rule templates provided by Wazuh, I came across not only templates for Sysmon, but rules that follow common ways to lock against certain eventID 1 events.
![Desktop View](/assets/posts/SOARSIEM/mimikatz-rule-initial.png)
![Desktop View](/assets/posts/SOARSIEM/mimikatz-rule-final.png)  

I simply copy and pasted the existing rule and changed the following:
- __rule id__ ->  +1 of the pre-existing custom rule
- __level__ -> 'level' can go from 0-16. I made it 16 just for fun.
- __field__ -> Line 21 (dotted in picture) tracks mimikatz (not case sensitive indicated by '(?i)' in the originalFileName)
- __description__ -> Indicate that mimikatz is found on the user Agent
- __mitre__ -> To reflect "OS Credential Dumping" (T1003)  

Now, I can test my rule. 

On the Windows 10 Wazuh Agent, I installed mimikatz and changed the name of the executable and ran it.
![Desktop View](/assets/posts/SOARSIEM/mimikatz-rule-prerun.png)
![Desktop View](/assets/posts/SOARSIEM/mimikatz-rule-postrun.png)  
Note how the headers match the information I put into the rule, and how the image name does not match the originalFileName!  
![Desktop View](/assets/posts/SOARSIEM/mimikatz-rule-header.png)
![Desktop View](/assets/posts/SOARSIEM/mimikatz-rule-subheader.png)