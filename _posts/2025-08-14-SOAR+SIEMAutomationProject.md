---
title: SOAR/SIEM Automation Project
date: 2025-08-31 00:00:00 +/-0500
description:  Ingesting Sysmon telemetry to Wazuh agents and utilizing Shuffle's automation to automatically configure and send alerts to TheHive, checking hashes and IPs with VirusTotal's database, and utilizing user input to finalize active response commands to requisite agents via email.
categories: [Personal Projects]
tags:   # TAG names should always be lowercase
---
## Mimikatz Workflow

### Infrastructure
![Desktop View](/assets/posts/SOARSIEM/preresponseNetworkDiagram.png)
<!-- ![Desktop View](/assets/posts/SOARSIEM/preresponseNetworkDiagram.png){: w="716" h="714" }  -->
- Both the Wazuh and TheHive Managers are hosted in separate Digital Ocean Ubuntu Droplets (VMs).  
- The Wazuh Agent is used to aggregate logs collected with Sysmon to the Wazuh Manager. It's hosted on my main machine where I also access the cloud consoles from.  
- Wazuh is then configured to connect to the SOAR software, Shuffle, to automatically calculate the SHA256 hash from the mimikatz.exe alert to send to VirusTotal, generating an alert for TheHive, and sending a separate email for (theoretical) SOC Analysts  

### Installation/Configuration

#### Firewall
![Desktop View](/assets/posts/SOARSIEM/digitaloceanFirewall.png){: w="200" .right }
Before initializing both the Wazuh and TheHive managers, by default port 22 (SSH) is open by default to allow remote connections by anyone. Obviously, for security reasons I need to restrict access to SSH or simply just close off the port to avoid scanners probing the droplets. I opted to just remove the option to connect via SSH and instead use the console provided by DigitalOcean. I also enabled all TCP/UDP connections from my public IP address for the Wazuh Agent to be able to communicate to/from the Wazuh Manager.

<!-- -->  
#### Wazuh Agent

The Wazuh Manager has a very convenient way to setup the curl command to setup the Wazuh Agent. By selecting the OS version, and the IP address of the manager, it automatically creates a curl command and provides additional commands to start the service on the agent.  
```bash
curl -o wazuh-agent-4.7.5-1.x86_64.rpm https://packages.wazuh.com/4.x/yum/wazuh-agent-4.7.5-1.x86_64.rpm && sudo WAZUH_MANAGER='<public IP of Wazuh Manager>' WAZUH_AGENT_NAME='<Agent Name>' rpm -ihv wazuh-agent-4.7.5-1.x86_64.rpm
```
Below is the configured Windows 10 Wazuh Agent.  
![Desktop View](/assets/posts/SOARSIEM/wazuh-manager-agents.png)
_I named the agent, 'socforensicsincidentresponse' to remember the 'FIR' in 'DFIR' :)_  

Installing sysmon is even easier. By installing the the Sysmon service through the Microsoft Documentation, and a systemconfig.xml file offered through the GitHub linked in that documentation page.
```bash
.\Sysmon.exe -i sysmonconfig.xml
```
Under the 'ossec.conf' file under C:\Program Files (x86)\ossec-agent, I edited the already existing localfile header to the Sysmon file path (Microsoft-Windows-Sysmon/Operational) so that the Wazuh agent gets logs generated by Sysmon under the Log Analysis Section  
![Desktop View](/assets/posts/SOARSIEM/wazuh-agent-sysmon.png)
#### TheHive Manager

Following TheHive's installation/configuration steps through their [documentation](https://docs.strangebee.com/thehive/installation/step-by-step-installation-guide/){: target="_blank"}, essentially it configures the Cassandra and ElasticSearch services to be able to communicate with TheHive Manager.

#### Wazuh Manager

For testing purposes, all logs will be pushed to the Wazuh Manager whether it triggers an alert/rule or not. To do this, I must change certain settings within the ossec.conf file and the Filebeats service configuration file on the _Wazuh Manager_ to reflect this.
![Desktop View](/assets/posts/SOARSIEM/wazuh-manager-ossec.png)
_Underlined terms were originally 'no'_  
Logs are saved under /var/ossec/logs/archives . Because I am ingesting ALL logs rather than just alerts, I need to configure the Filebeat service to reflect that. Under /etc/filebeat/filebeat.yml there is an area to enable archives.
![Desktop View](/assets/posts/SOARSIEM/wazuh-manager-filebeats.png)
_Like before, underlined term was originally 'false'_  
On the Wazuh Manager GUI itself, I still need to define another index pattern that reflects the archives themselves.
![Desktop View](/assets/posts/SOARSIEM/wazuh-manager-index.png)
The index goes through Wazuh's files, within its archives, and the '**' at the end defines everything within said archives.  

### Detecting Mimikatz 
Now that the log ingestion is configured and ready to go, it is time to create a custom rule that detects specifically Mimikatz. Because all archies are ingested, I can select some random log to look at the attributes that Sysmon offers.
![Desktop View](/assets/posts/SOARSIEM/mimikatz-initial-log.png)
The attributes in particular that I focused on are
- data.win.eventdata.image
	- The rule that will be created proves that this can be _very_ easily spoofed
- data.win.system.eventID
	- an eventID of 1 represents Process Creation. In properly made rules, this attributed used in tandem with other events contribute to process lineage to give insights on how the potential malware works or vulnerabilities within the environment.
- data.win.eventdata.originalFileName 
	- This will be used to circumvent spoofing the data.win.eventdata.image name.
![Desktop View](/assets/posts/SOARSIEM/mimikatz-attributes.png)

#### Rule Creation

After scouring the rule templates provided by Wazuh, I came across not only templates for Sysmon, but rules that follow common ways to lock against certain eventID 1 events.
![Desktop View](/assets/posts/SOARSIEM/mimikatz-rule-initial.png)
![Desktop View](/assets/posts/SOARSIEM/mimikatz-rule-final.png)  

I simply copy and pasted the existing rule and changed the following:
- __rule id__ ->  +1 of the pre-existing custom rule
- __level__ -> 'level' can go from 0-16. I made it 16 just for fun.
- __field__ -> Line 21 (dotted in picture) tracks mimikatz (not case sensitive indicated by '(?i)' in the originalFileName)
- __description__ -> Indicate that mimikatz is found on the user Agent
- __mitre__ -> To reflect "OS Credential Dumping" (T1003)  

#### Rule Testing

Now, I can test my rule. 

On the Windows 10 Wazuh Agent, I installed mimikatz and changed the name of the executable and ran it.
![Desktop View](/assets/posts/SOARSIEM/mimikatz-rule-prerun.png)
![Desktop View](/assets/posts/SOARSIEM/mimikatz-rule-postrun.png)  
Note how the headers match the information I put into the rule, and how the image name does not match the originalFileName!  
![Desktop View](/assets/posts/SOARSIEM/mimikatz-rule-header.png)
![Desktop View](/assets/posts/SOARSIEM/mimikatz-rule-subheader.png)

### Shuffle (SOAR) Automation

Now with the rule configured, for the sake of testing I can configure the Wazuh Manager to only push alerts with the Mimikatz Rule ID, 100002, to shuffle.
Following these steps within this [Wazuh blog,](https://wazuh.com/blog/integrating-wazuh-with-shuffle/){: target="_blank"} I can copy the following code block into the ossec.conf file within the Wazuh Manager and replace the appropriate data.
```bash
<integration>
  <name>shuffle</name>
  <hook_url>http://<YOUR_SHUFFLE_URL>/api/v1/hooks/<HOOK_ID></hook_url>
  <level>3</level>
  <alert_format>json</alert_format>
</integration>
```

#### Shuffle Webhook URI

![Desktop View](/assets/posts/SOARSIEM/shuffle-inital-uri.png){: w="425" .right }
I then copy the Webhook URI provided from the Webhook App I added to the Shuffle workspace, replace the <hook_url>, and also replace the 'level' tag with the 'rule_id' tag with the Mimikatz Rule ID (100002), which is similar in formatting to the custom rule earlier.  

![Desktop View](/assets/posts/SOARSIEM/shuffle-wazuhman-url.png)  
To save the changes, I saved the ossec.conf file and restarted the service. Once that was done, I reran Mimikatz on the Wazuh Agent, and tested the workflow. If it worked, I would see the attributes I set within the Wazuh rule within Shuffle and I'd be able to take those attributes to be able to use them for the workflow.
![Desktop View](/assets/posts/SOARSIEM/shuffle-initial-run.png)  

#### SHA256_Regex

Within the aforementioned attributes, Wazuh automatically calculates the MD5, SHA256, and Import hashes of the file.
![Desktop View](/assets/posts/SOARSIEM/shuffle-hash-attribute.png)  
However, Wazuh puts all of these hashes on the same variable. Looking through the apps, the only way to get one checksum from the line is Regex code within a Shuffle Tools app. I don't know how to code in Regex, so I asked ChatGPT to only get the SHA256 sum from the input.
![Desktop View](/assets/posts/SOARSIEM/shuffle-chatgpt.png)  

<!-- ![Desktop View](/assets/posts/SOARSIEM/shuffle-virustotal-1.png){: w="250" .right } - Image may be unnecessary and takes too much space relative to the info it gives-->

#### VirusTotal

![Desktop View](/assets/posts/SOARSIEM/shuffle-virustotal-2.png){: w="260" .right }
I set the SHA256_Regex output to the VirusTotal app, but first I had to set up the authentication process for it. I created an account to get an API key used to authenticate the app. Through this app, similar to getting the attributes from the Mimikatz rule trigger, I can see the amount of vendors that list the mimikatz.exe as malicious, and its overall reputation score.  
<br>

<!--
Reminder to delete these shuffle-virus-total 1 2 and 3

![Desktop View](/assets/posts/SOARSIEM/shuffle-virustotal-3.png){: w="250" .left }  

![Desktop View](/assets/posts/SOARSIEM/shuffle-virustotal-4.png){: w="225" .right }  

-->
<br>

#### TheHive

Now to extend the workflow to create an alert on the TheHive manager. Before that, I need to create a new orginization, as well as two user accounts, one service account to establish the API key to connect to TheHive app, and the other one is a user account to receive the alerts I create and push through Shuffle. I used a pre-made profile which gives a variety positions. Note that in a real environment, this would be configured with the idea of least privilege, which is not a concern for this demo.
![Desktop View](/assets/posts/SOARSIEM/shuffle-thehive-org.png)
_'admin' organization is created by default. My Organization is the name I decided for mine._
![Desktop View](/assets/posts/SOARSIEM/shuffle-thehive-users.png){: .right }  
For the Analyst account, I made a password and once an alert is created and pushed by Shuffle, I would have logged into the account to see the user with the username 'myorganization@test.com'.
On the left below, these are the initial settings I had. Testing the workflow I ran into the following issue on the right.
![Desktop View](/assets/posts/SOARSIEM/shuffle-thehive-initial-settings.png){: w="" .left } 
![Desktop View](/assets/posts/SOARSIEM/shuffle-thehive-initial-error.png){: w="420" .left }

Looking for solutions, I browsed through the other settings and switched to the advanced tab which is all the inputs but formatted in JSON. This was a long and arduous process. I had to trial and error and figured out through searching up the error codes from TheHive app that they have documentation on required fields and their type of inputs [here.](https://docs.strangebee.com/thehive/api-docs/#tag/Alert/operation/Create%){: target="_blank"}  

![Desktop View](/assets/posts/SOARSIEM/shuffle-thehive-initial-body.png)
_Initial json_
![Desktop View](/assets/posts/SOARSIEM/shuffle-thehive-final-body.png)
_Final json_
Running the workflow then logging into the Analyst user account on My Organization on TheHive website, it works!
![Desktop View](/assets/posts/SOARSIEM/shuffle-thehive-alert.png)
![Desktop View](/assets/posts/SOARSIEM/shuffle-thehive-alert-1.png)

#### Email Alerts

![Desktop View](/assets/posts/SOARSIEM/shuffle-email-attribute.png){: w="225" .right }  
This portion was the easiest. 3 easy-to-fill fields and I used the same attributes used within TheHive app configuration. I assume for Google or Outlook addresses there would have to be extra authentication. The follow are successful runs of not only the workflow, but the temporary email receiving it as well.
![Desktop View](/assets/posts/SOARSIEM/shuffle-email-final-1.png){: .left }
![Desktop View](/assets/posts/SOARSIEM/shuffle-email-final-2.png)

### Final Shuffle Workflow

![Desktop View](/assets/posts/SOARSIEM/shuffle-workflow-1.png)

## Challenge - Configuring Active Response prompts to SSH Attack

For this section, I wanted to take this further by completing the following objectives.  

1. Create another Wazuh Agent with all inbound communications open.
2. Add or change a rule that pushes ALL level 5 alerts to Shuffle
3. Instead of sending hashes, send IP addresses that try to scan/connect with said Agent
4. Configure custom alerts to send to TheHive manager for the Analyst Account
5. Create Active Response command that adds an IP address to the host' IP tables to be dropped
6. Configure emails within Shuffle to ask user whether they want to block the IP address or not. 

### Infrastructure

![Desktop View](/assets/posts/SOARSIEM/post-response-network-diagram.png)
- Other Wazuh Agent is an Ubuntu 22.04 x64 Digital Ocean Droplet.
- Added the communication steps for active response 

### Initial Steps

Because I'm opening all communications to genuine bot scanning traffic, I did not want to host on-prem via VirtualBox VM to avoid DOS attacks to my host machine and the rest of my family's devices.  
![Desktop View](/assets/posts/SOARSIEM/challenge-other-droplet.png)  
I preemptively made a firewall that opens all connections, but will only implement it for testing.
![Desktop View](/assets/posts/SOARSIEM/challenge-other-droplet-firewall.png)
 
### Push different alerts  
 
 To address objective #2, instead of pushing alerts that trigger the Mimikatz Rule ID (100002), I replaced the rule tag with level tags and set it to level 5 alerts.  
 ![Desktop View](/assets/posts/SOARSIEM/final-rule-replace.png)  
 
### Workflow

#### Http App - curl

![Desktop View](/assets/posts/SOARSIEM/final-workflow-diagram.png)  
In order to configure third party apps to perform actions from Wazuh, I need to authenticate my connect via a JWT. Following [this link](https://documentation.wazuh.com/current/user-manual/api/getting-started.html#understanding-the-wazuh-server-api-request-and-response){: target="_blank"} there is a curl command that can be used to establish the JWT authenticated session. The localhost would be replaced with the IP address of the Wazuh Manager.
```bash
TOKEN=$(curl -u <WAZUH_API_USER>:<WAZUH_API_PASSWORD> -k -X POST "https://localhost:55000/security/user/authenticate?raw=true")
```
This token is established alongside the "payload" i.e the specific commands and alerts you would tell Wazuh to execute/look for on relevant agent IDs. There is an option to include the Wazuh Shuffle App within the workload itself, so the Http app acts as the TOKEN, and the Wazuh Shuffle App acts as the payload and is responsible for its delivery. I replaced the POST http request with GET I will call the Wazuh App rather than sending the payload. There is no inherent benefit within the scope of this project, but is just another way to establish connection to the Wazuh API. I also opened up port 55000 on the already existing firewall for the Wazuh Manager droplet in order to establish the JWT.  
![Desktop View](/assets/posts/SOARSIEM/final-curl-attributes.png)   

#### VirusTotal

This will then output to the VirusTotal app, and I configured it to get an ip address report to see the attributes of the IP address of the attempted connection.  
![Desktop View](/assets/posts/SOARSIEM/final-workflow-virustotal.png)  

#### TheHive

For TheHive, I had to mess with the JSON and keep in mind the required object types for each key. Within TheHive alerts, cases are divided between source, sourceRef, and type. Essentially, if I used static values rather than $exec values, alerts would not be able to be made despite there being different IP addresses or rules triggered.  
In a bigger, more realistic environment, these would be used much more efficiently and would provide helpful insight to the analyst that takes the ticket. For this demo I replaced:
- source - the agent ID that contains triggered alert
- sourceRef - source IP of triggered alaert
- type - the Rule Triggered  
![Desktop View](/assets/posts/SOARSIEM/final-workflow-thehive-json.png)  

#### Email 

Pretty much same as the Mimikatz one, just with the source IP variable instead and no host name, because the default wazuh rules do not include everything, unlike the custom Mimikatz rule.  
![Desktop View](/assets/posts/SOARSIEM/final-workflow-email.png)  

#### User input

User Input triggers for emails automatically configure two links to allow or deny the continuation of the workflow, so the inputs are very simple.  
![Desktop View](/assets/posts/SOARSIEM/final-workflow-userinput.png)  

#### Active Response via Wazuh Manager

Searching through Wazuh's Documentation, [agent-control](https://documentation.wazuh.com/current/user-manual/reference/tools/agent-control.html){: target="_blank"} and learning how to configure the [active response](https://documentation.wazuh.com/current/user-manual/capabilities/active-response/how-to-configure.html){: target="_blank"}  
Within /var/ossec/etc/ossec.conf, there are active-response tags that are commented out. I removed them and created the following lines to block the source IP of an alert provided it is at least level 5.  
![Desktop View](/assets/posts/SOARSIEM/final-workflow-activeresponse.png)  
To test whether the active response command was configured correctly, I executed 
```bash
/var/ossec/bin/agent_control -L
```
to get this:  
![Desktop View](/assets/posts/SOARSIEM/final-workflow-agentcontrol.png)  
I spent forever finding out that firewall-drop is not the command to use through the Wazuh App. "Response name" seems obvious now but hindsight is 20/20.  
<br>
These are the attributes of the Wazuh App:  
![Desktop View](/assets/posts/SOARSIEM/final-workflow-wazuh-1.png){: .left }  
![Desktop View](/assets/posts/SOARSIEM/final-workflow-wazuh-2.png){: .right }  
![Desktop View](/assets/posts/SOARSIEM/final-workflow-wazuh-3.png)  

## Final Results

### VirusTotal

The source IP address that was chosen for this final workflow, was 194.0.234.19, originting from Iran.
![Desktop View](/assets/posts/SOARSIEM/final-result-1.png)  

### TheHive

![Desktop View](/assets/posts/SOARSIEM/final-result-2.png) 

### Emails - General Alert + User input

![Desktop View](/assets/posts/SOARSIEM/final-result-3.png)  

### iptables of Ubuntu droplet

![Desktop View](/assets/posts/SOARSIEM/final-result-4.png)  

## Conclusion

The iptables of the ubuntu machine are blocking the source IPs, but have multiple entries that definitely clog up the entries. After letting it run after documenting the picture, it was blocking domain names rather than just source IPs which was weird.  
My assumption is because I configured all logs to be pushed to the Wazuh Manager, the archives are disabled by default because it does not delete/refresh the logs. So even after I flush the ubuntu machine's iptables, the workflow attempts every step for EVERY level 5 log that is pushed to the manager. Not only that, many of these port scanners most likely trigger more than one rule, creating many unnecessary entries. I also found out that the default active response command rules include the description, 'Host Blocked by firewall-drop Active Response' so I had to filter that out and realize that not including a description to my custom active response firewall-drop command was not the best idea. Better to be more verbose than less in these cases. There are logs that say an active-response command was logged originating from the ossec.conf file, so it does work.  
In addition, I already figured that active-response to each IP address ironically causes more alarm fatigue than without, but it is nice to somewhat simulate conditions without having the insight working in an enterprise environment would give.  

## Additional Comments

I used [MyDFIR's tutorial](https://www.youtube.com/watch?v=Lb_ukgtYK_U&list=PLEd_qaF8wpnXgdngqfsQtYYGM-IdtuxmC){: target="_blank"}  and tried as much as possible to not completely rely on the tutorial. I will say it's very hard to try to come up with ideas not doing projects of this scale and relevance, nor working in a technical environment. The most experience I had were school labs that pretty much held my hand where the most I can come up with is just using the software it introduces but outside of the project and tinkering with it. I will say, after doing the project, looking through all the documentation, and going through all the trial and error, I can safely explain each step of this project and where I can improve on as well.

Many of the simple fields used in the video just did not work properly. I had to go through the advance view and edit the JSON body there itself. A culimination of many of these problems that I did not have prior experience with, and a lack of organization for both the main project and figuring out how to format the static site because I did not fully understand the scope of the project, made it a bit of an arduous process to go through. I actually almost gave up halfway and three-quarters of the way and had to take mini-breaks to avoid burnout.

I will say this was very insightful. It makes me want to research how to develop YARA rules and enriches those personal databases, tuning and configuring rules in the context of proper Incident Response and for SOC Analysts, and makes me want to create an on-prem home lab with a focus on switches, or simulating with cisco packet tracer. This also made me more confident in navigating unknown topics and breaking down complex ideas into something more digestible. An underrated portion of these projects, is the determination and ability to not give up, and how documentation of these projects in a somewhat-coherent manner really helps with learning the content.